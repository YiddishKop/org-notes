<p>
Emacs.SE has truly revived my init file. Every day, a new snippet gets
added. I <a href="/auto-focus-a-relevant-file-in-dired-buffers.html">started this series</a> only 6 days ago, and it’s already on its
fourth episode. 
</p>

<p>
<a href="http://emacs.stackexchange.com/q/443/50">Today's question</a> was asked by me, and answered by Tikhon Jelvis,
Francesco, and Sacha Chua. As usual, this link might not work for you
until the beta goes public.
</p>

<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1">Question</h2>
<div class="outline-text-2" id="text-1">
<p>
I’ve long been keeping my LaTeX documents under version control.
Still, the effectiveness of this initiative would be greatly improved
if I could bring myself to adopt a <i>“one-sentence-per-line”</i> approach.
It would facilitate managing people’s conributions and reverting old
changes.
</p>

<p>
If you’re wondering what’s so difficult about that, here is what such
a document would look like. (<i>Long sentences are to be avoided, but in
scientific writing you don’t always have a choice</i>).
</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">A quite short sentence here.
New sentence on the same paragraph, with more text with more text with more text with more text.
Some more text, still on the same paragraph.
This is another very very very very very very very very very very very very very very very very very very very very long sentence.</code></pre></figure>
<p>
The lack of readability above is evident. Having text extend beyond 80
columns is trouble enough, but intertwining long and short lines just
makes my brain weep in despair.
</p>

<p>
The official solution is to activate <a href="http://doc.endlessparentheses.com/Fun/visual-line-mode"><code>visual-line-mode</code></a> and add window
margins (or just decrease window width). That causes the lines to wrap
(visually, not in the file) and increases readability by an order of
magnitude.
</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">A quite short sentence here.
New sentence on the same paragraph, with more text with more
text with more text with more text.
Some more text, still on the same paragraph.
This is another very very very very very very very very very
very very very very very very very very very very very long
sentence.</code></pre></figure>
<p>
But alas, it comes at a cost. If this text were indented by a few
spaces (quite common in LaTeX), the outcome looks like it went through
a blender. And don’t get me started on broken equations.
</p>
<figure class="highlight"><pre><code class="language-text" data-lang="text">    A quite short sentence here.
    New sentence on the same paragraph, with more text with
more text with more text with more text.
    Some more text, still on the same paragraph.
    This is another very very very very very very very very
very very very very very very very very very very very very
long sentence.
    \begin{equation}
        H = equation * lines + sometimes - \need{to}{be / 
long}
    \end{equation}</code></pre></figure>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2">Solution</h2>
<div class="outline-text-2" id="text-2">
<p>
<i>tdsh points out in the comments, the <a href="http://elpa.gnu.org/packages/adaptive-wrap.html"><code>adaptive-wrap</code></a> package fixes
the indentation issue for <code>visual-line-mode</code>.</i>
</p>

<p>
The solution reached is a hack to make <a href="http://doc.endlessparentheses.com/Fun/longlines-mode"><code>longlines-mode</code></a> act more
intelligently on LaTeX buffers. This minor mode is similar to the
combination of <code>visual-line-mode</code> and window margins mentioned
above. It makes lines wrap at <a href="http://doc.endlessparentheses.com/Var/fill-column"><code>fill-column</code></a>, intead of <code>window-width</code>.
</p>

<p>
The advantage to <code>longlines-mode</code> is that it’s implemented in elisp
(while window margins are done in C code), so we can hack it to our
hearts’ content. Bafflingly, this little gold nugget has been marked
obsolete on Emacs 24.4.
</p>

<p>
The hack below does 3 things:
</p>
<ol class="org-ol">
<li>It enables “soft” wrapping of text. That is, the text is wrapped to
<code>fill-column</code> in the buffer, but that does not reflect in the file.
</li>
<li>It fixes the indentation problem. So wrapping an indented line follows
the line’s indentation. So environments with indented text (like itemize, or
theorem) are <b>much</b> more readable.
</li>
<li>It even prevents wrapping of equations!
</li>
</ol>

<p>
The code is a bit heavy, so I’ve added comments describing the lines
which were actually changed.
</p>
<figure class="highlight"><pre><code class="language-cl" data-lang="cl"><span class="p">(</span><span class="nb">require</span> <span class="ss">'longlines</span> <span class="no">nil</span> <span class="no">t</span><span class="p">)</span>
<span class="p">(</span><span class="nv">add-hook</span> <span class="ss">'LaTeX-mode-hook</span> <span class="nf">#'</span><span class="nv">longlines-mode</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">longlines-encode-region</span> <span class="p">(</span><span class="nv">beg</span> <span class="nv">end</span> <span class="k">&amp;optional</span> <span class="nv">_buffer</span><span class="p">)</span>
  <span class="s">"Replace each soft newline between BEG and END with exactly one space.
Hard newlines are left intact. The optional argument BUFFER exists for
compatibility with `format-alist', and is ignored."</span>
  <span class="p">(</span><span class="nv">save-excursion</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">reg-max</span> <span class="p">(</span><span class="nb">max</span> <span class="nv">beg</span> <span class="nv">end</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">mod</span> <span class="p">(</span><span class="nv">buffer-modified-p</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nb">min</span> <span class="nv">beg</span> <span class="nv">end</span><span class="p">))</span>
      <span class="c1">;; Changed this line to "swallow" indendation when decoding.</span>
      <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nv">search-forward-regexp</span> <span class="s">" *\\(\n\\) *"</span> <span class="nv">reg-max</span> <span class="no">t</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">pos</span> <span class="p">(</span><span class="nv">match-beginning</span> <span class="mi">1</span><span class="p">)))</span>
          <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">get-text-property</span> <span class="nv">pos</span> <span class="ss">'hard</span><span class="p">)</span>            
            <span class="p">(</span><span class="nv">goto-char</span> <span class="p">(</span><span class="nv">match-end</span> <span class="mi">0</span><span class="p">))</span>   <span class="c1">; This line too</span>
            <span class="p">(</span><span class="nv">insert-and-inherit</span> <span class="s">" "</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">replace-match</span> <span class="s">""</span> <span class="ss">:fixedcase</span> <span class="ss">:literal</span><span class="p">)</span> <span class="c1">; This line too</span>
            <span class="p">(</span><span class="nv">remove-text-properties</span> <span class="nv">pos</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">pos</span><span class="p">)</span> <span class="ss">'hard</span><span class="p">))))</span>
      <span class="p">(</span><span class="nv">set-buffer-modified-p</span> <span class="nb">mod</span><span class="p">)</span>
      <span class="nv">end</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">longlines-wrap-line</span> <span class="p">()</span>
  <span class="s">"If the current line needs to be wrapped, wrap it and return nil.
If wrapping is performed, point remains on the line. If the line does
not need to be wrapped, move point to the next line and return t."</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">bound-and-true-p</span> <span class="nv">latex-extra-mode</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">null</span> <span class="p">(</span><span class="nv">latex/do-auto-fill-p</span><span class="p">)))</span>
      <span class="p">(</span><span class="k">progn</span> <span class="p">(</span><span class="nv">forward-line</span> <span class="mi">1</span><span class="p">)</span> <span class="no">t</span><span class="p">)</span>
    <span class="c1">;; The conditional above was added for latex equations. It relies</span>
    <span class="c1">;; on the latex-extra package (on Melpa).</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">longlines-set-breakpoint</span><span class="p">)</span>
             <span class="c1">;; Make sure we don't break comments.</span>
             <span class="p">(</span><span class="nb">null</span> <span class="p">(</span><span class="nb">nth</span> <span class="mi">4</span> <span class="p">(</span><span class="nv">parse-partial-sexp</span>
                           <span class="p">(</span><span class="nv">line-beginning-position</span><span class="p">)</span> <span class="p">(</span><span class="nv">point</span><span class="p">)))))</span>
        <span class="p">(</span><span class="k">progn</span>
          <span class="c1">;; This `let' and the `when' below add indentation to the</span>
          <span class="c1">;; wrapped line.</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">indent</span> <span class="p">(</span><span class="nv">save-excursion</span> <span class="p">(</span><span class="nv">back-to-indentation</span><span class="p">)</span>
                                        <span class="p">(</span><span class="nv">current-column</span><span class="p">))))</span>
            <span class="p">(</span><span class="nv">insert-before-markers-and-inherit</span> <span class="nv">?\n</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">backward-char</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">delete-char</span> <span class="mi">-1</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">forward-char</span> <span class="mi">1</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">indent</span> <span class="mi">0</span><span class="p">)</span>
              <span class="p">(</span><span class="nv">save-excursion</span>
                <span class="p">(</span><span class="nv">insert</span> <span class="p">(</span><span class="nb">make-string</span> <span class="nv">indent</span> <span class="nv">?</span> <span class="p">)))</span>
              <span class="p">(</span><span class="k">setq</span> <span class="nv">longlines-wrap-point</span>
                    <span class="p">(</span><span class="nb">+</span> <span class="nv">longlines-wrap-point</span> <span class="nv">indent</span><span class="p">))))</span>
          <span class="no">nil</span><span class="p">)</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">longlines-merge-lines-p</span><span class="p">)</span>
          <span class="p">(</span><span class="k">progn</span> <span class="p">(</span><span class="nv">end-of-line</span><span class="p">)</span>
                 <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nv">bolp</span><span class="p">)</span> <span class="p">(</span><span class="nv">forward-char</span> <span class="mi">1</span><span class="p">))</span> <span class="p">(</span><span class="nv">eolp</span><span class="p">))</span>
                     <span class="p">(</span><span class="k">progn</span>
                       <span class="p">(</span><span class="nv">delete-char</span> <span class="mi">-1</span><span class="p">)</span>
                       <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">longlines-wrap-point</span> <span class="p">(</span><span class="nv">point</span><span class="p">))</span>
                           <span class="p">(</span><span class="k">setq</span> <span class="nv">longlines-wrap-point</span>
                                 <span class="p">(</span><span class="nb">1-</span> <span class="nv">longlines-wrap-point</span><span class="p">))))</span>
                   <span class="p">(</span><span class="nv">insert-before-markers-and-inherit</span> <span class="nv">?\s</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">backward-char</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">delete-char</span> <span class="mi">-1</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">forward-char</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="c1">;; This removes whitespace added for indentation.</span>
                   <span class="p">(</span><span class="nv">while</span> <span class="p">(</span><span class="nb">eq</span> <span class="p">(</span><span class="nv">char-after</span><span class="p">)</span> <span class="nv">?</span> <span class="p">)</span>
                     <span class="p">(</span><span class="nv">delete-char</span> <span class="mi">1</span><span class="p">)</span>
                     <span class="p">(</span><span class="k">setq</span> <span class="nv">longlines-wrap-point</span>
                           <span class="p">(</span><span class="nb">1-</span> <span class="nv">longlines-wrap-point</span><span class="p">))))</span>
                 <span class="no">nil</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">forward-line</span> <span class="mi">1</span><span class="p">)</span>
        <span class="no">t</span><span class="p">))))</span></code></pre></figure>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1">Update <span class="timestamp-wrapper"><span class="timestamp">&lt;2014-10-07 Tue&gt;</span></span></h3>
<div class="outline-text-3" id="text-2-1">
<p>
Fixed handling of comments. Now comments don’t get wrapped either.
</p>
</div>
</div>
</div>

   <p><a href="http://endlessparentheses.com/longlines-mode-in-latex.html?source=rss#disqus_thread">Comment on this.</a></p>